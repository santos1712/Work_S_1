<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>๐ฎ ูุนุจุฉ ุงูุฌุงุณูุณ - Spyfall</title>
    <link rel="stylesheet" href="style.css">
    <!-- ุชุญููู Discord SDK ุฃููุงู -->
    <script src="https://unpkg.com/@discord/embedded-app-sdk@latest"></script>
</head>
<body>
    <!-- ุดุงุดุฉ ุงูุชุญููู -->
    <div id="loading-screen" class="screen">
        <div class="loading-content">
            <div class="spinner"></div>
            <h1>๐ฎ ุฌุงุฑู ุชุญููู ูุนุจุฉ ุงูุฌุงุณูุณ...</h1>
            <p>ููุชุฑุญ ุงููุนุจุฉ: Angle | ูุทูุฑ ุงูุจูุช: Marwan Santos</p>
            <div id="loading-error" class="error-message hidden">
                <p>โ๏ธ ุญุฏุซ ุฎุทุฃ ูู ุงูุชุญููู. ูุฑุฌู:</p>
                <ul>
                    <li>ุงูุชุฃูุฏ ูู ูุชุญ Discord ูู ูุชุตูุญ ุณุทุญ ุงูููุชุจ</li>
                    <li>ุงูุชุฃูุฏ ูู ุชูุงุฌุฏู ูู ููุงุฉ ุตูุชูุฉ</li>
                    <li>ุชุญุฏูุซ ุงูุตูุญุฉ (F5)</li>
                </ul>
                <button id="retry-btn" class="btn btn-primary">๐ ุฅุนุงุฏุฉ ุงููุญุงููุฉ</button>
            </div>
        </div>
    </div>

    <!-- ุงูุดุงุดุฉ ุงูุฑุฆูุณูุฉ -->
    <div id="main-screen" class="screen hidden">
        <!-- ุงูููุฏุฑ -->
        <header class="game-header">
            <div class="header-left">
                <h1>๐ญ ูุนุจุฉ ุงูุฌุงุณูุณ</h1>
                <div id="game-phase" class="phase-indicator">ุฌุงุฑู ุงูุฅุนุฏุงุฏ...</div>
            </div>
            <div class="header-right">
                <div id="timer" class="timer">02:00</div>
                <div id="player-count" class="player-count">๐ฅ 0 ูุงุนุจูู</div>
                <div id="sdk-status" class="sdk-status disconnected" title="ุญุงูุฉ ุงุชุตุงู Discord">๐ด</div>
            </div>
        </header>

        <!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
        <main class="game-container">
            <!-- ููุญุฉ ุงููุดุงุฑููู -->
            <section class="players-panel">
                <h2>๐ฅ ุงููุงุนุจูู ูู ุงูุตูุช</h2>
                <div id="players-list" class="players-list">
                    <!-- ุณูุชู ุชุนุจุฆุชู ุฏููุงูููููุง -->
                    <div class="no-players-message">
                        <p>โ๏ธ ุงูุถู ุฅูู ููุงุฉ ุตูุชูุฉ ูู Discord ูุฑุคูุฉ ุงููุงุนุจูู</p>
                    </div>
                </div>
                <div class="host-controls">
                    <button id="start-game-btn" class="btn btn-primary" disabled>
                        ุจุฏุก ุงููุนุจุฉ (ูุทููุจ 3-8 ูุงุนุจูู)
                    </button>
                    <button id="restart-btn" class="btn btn-secondary hidden">
                        ๐ ุฅุนุงุฏุฉ ุงููุนุจุฉ
                    </button>
                    <button id="debug-btn" class="btn btn-warning">
                        ๐ ูุถุน ุงูุชุตุญูุญ
                    </button>
                </div>
            </section>

            <!-- ููุญุฉ ุงููุนุจุฉ ุงูุฑุฆูุณูุฉ -->
            <section class="game-panel">
                <!-- ุดุงุดุฉ ุงูุงุชุตุงู -->
                <div id="connection-view" class="action-view">
                    <h2>๐ ุงูุงุชุตุงู ุจู Discord</h2>
                    <div class="connection-status">
                        <div class="status-item">
                            <span class="status-label">ุญุงูุฉ SDK:</span>
                            <span id="sdk-status-text" class="status-value">โ ุบูุฑ ูุชุตู</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ูุนุฑู ุงูุชุทุจูู:</span>
                            <span class="status-value">1428774370012041246</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ุงููุณุชุฎุฏู:</span>
                            <span id="user-status" class="status-value">ุบูุฑ ูุญุฏุฏ</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ุงูููุงุฉ ุงูุตูุชูุฉ:</span>
                            <span id="channel-status" class="status-value">ุบูุฑ ูุญุฏุฏ</span>
                        </div>
                    </div>
                    
                    <div class="connection-instructions">
                        <h3>๐ ุชุนูููุงุช ุงูุชุดุบูู:</h3>
                        <ol>
                            <li>ุงูุชุญ <strong>Discord</strong> ุนูู ุณุทุญ ุงูููุชุจ</li>
                            <li>ุงูุถู ุฅูู <strong>ููุงุฉ ุตูุชูุฉ</strong></li>
                            <li>ุงููุฑ ุนูู ุฒุฑ <strong>"Activities"</strong> (๐ฎ)</li>
                            <li>ุงุฎุชุฑ "ุชุตูุญ ุงูุฃูุดุทุฉ" ูุงุจุญุซ ุนู "Spyfall"</li>
                            <li>ุฃู ุงูุชุญ ูุฐุง ุงูุฑุงุจุท ูุจุงุดุฑุฉ ูู ุฏุงุฎู Discord</li>
                        </ol>
                    </div>
                    
                    <div class="connection-actions">
                        <button id="init-sdk-btn" class="btn btn-primary">
                            ๐ ุชููุฆุฉ ุงุชุตุงู Discord
                        </button>
                        <button id="check-players-btn" class="btn btn-secondary">
                            ๐ ูุญุต ุงููุงุนุจูู
                        </button>
                    </div>
                </div>

                <!-- ุนุฑุถ ุงูุฏูุฑ -->
                <div id="role-view" class="role-view hidden">
                    <div class="role-card" id="spy-card">
                        <h3>๐ญ ุฃูุช ุงูุฌุงุณูุณ!</h3>
                        <p>ุฃูุช <strong>ุงูุฌุงุณูุณ</strong> ูู ูุฐู ุงููุนุจุฉ!</p>
                        <div class="hints-box">
                            <h4>๐ก ุชูููุญุงุช ููุฃุณุฆูุฉ:</h4>
                            <ul>
                                <li>โข ูู ูุฐูุจ ุฅููู ูู ุงูุนุทูุงุชุ</li>
                                <li>โข ูู ูุญุชุงุฌ ุฅูู ุชุฐูุฑุฉุ</li>
                                <li>โข ูู ูููููุง ุงูุดุฑุงุก ูููุ</li>
                                <li>โข ูู ููู ููุธูููุ</li>
                                <li>โข ูู ููุชุญ ูู ุงููููุ</li>
                            </ul>
                        </div>
                    </div>
                    <div class="role-card" id="civilian-card">
                        <h3>๐ ุฃูุช ูุฏูู</h3>
                        <p>ุฃูุช <strong>ูุฏูู</strong> ูู ูุฐู ุงููุนุจุฉ!</p>
                        <div class="location-info">
                            <h4>๐ข ุงูููุงู: <span id="location-name">...</span></h4>
                            <div class="hints-box">
                                <h4>๐ก ุชูููุญุงุช ุงูููุงู:</h4>
                                <ul id="location-hints">
                                    <!-- ูุชู ุชุนุจุฆุชู ุฏููุงูููููุง -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ููุญุฉ ุงูุฌููุฉ -->
                <div id="round-view" class="round-view hidden">
                    <div class="round-header">
                        <h2>๐ ุงูุฌููุฉ <span id="current-round">1</span> ูู <span id="total-rounds">3</span></h2>
                        <div class="round-status">
                            <div id="speaker-indicator" class="speaker-indicator hidden">
                                ๐ค <span id="current-speaker">...</span> ูุชุญุฏุซ ุงูุขู
                            </div>
                        </div>
                    </div>

                    <!-- ุงุฎุชูุงุฑ ุงููุงุนุจ ููุณุคุงู -->
                    <div id="player-select-view" class="action-view hidden">
                        <h3>๐ค ุงุฎุชุฑ ูุงุนุจุงู ูุชุณุฃูู</h3>
                        <p>ุฃูุช: <strong id="current-player-name">...</strong></p>
                        <div id="selectable-players" class="players-grid">
                            <!-- ุฃุฒุฑุงุฑ ุงุฎุชูุงุฑ ุงููุงุนุจูู -->
                        </div>
                    </div>

                    <!-- ุณุคุงู ููุฏ ุงูุชูููุฐ -->
                    <div id="question-view" class="action-view hidden">
                        <h3>๐ค ุงูุณุคุงู ุฌุงุฑู</h3>
                        <div class="question-participants">
                            <div class="participant asker">
                                <div class="speaking-indicator active"></div>
                                <span id="asker-name">...</span>
                                <small>ุงูุณุงุฆู</small>
                            </div>
                            <div class="arrow">โ</div>
                            <div class="participant asked">
                                <div class="speaking-indicator"></div>
                                <span id="asked-name">...</span>
                                <small>ุงููุณุคูู</small>
                            </div>
                        </div>
                        <div class="question-timer">
                            โฐ ุงูููุช ุงููุชุจูู: <span id="question-time">02:00</span>
                        </div>
                        <button id="end-question-btn" class="btn btn-danger">
                            โ ุฅููุงุก ุงูุณุคุงู
                        </button>
                    </div>

                    <!-- ุชุตููุช ุงูุฌููุฉ -->
                    <div id="round-vote-view" class="action-view hidden">
                        <h3>๐ณ๏ธ ุชุตููุช ุงูุฌููุฉ</h3>
                        <p>ูู ุชุฑูุฏูู ุงุณุชููุงู ุงูุฌููุฉ ุงูุชุงููุฉ ุฃู ุงูุงูุชูุงู ููุชุตููุช ุงูููุงุฆูุ</p>
                        <div class="vote-options">
                            <button class="vote-btn btn-success" data-vote="continue">
                                ๐ ุงุณุชููุงู ุงูุฌููุฉ ุงูุชุงููุฉ
                            </button>
                            <button class="vote-btn btn-danger" data-vote="end">
                                โน๏ธ ุฅููุงุก ูุงูุชุตููุช ุงูููุงุฆู
                            </button>
                        </div>
                        <div class="votes-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="continue-progress" style="width: 0%"></div>
                                <div class="progress-fill" id="end-progress" style="width: 0%"></div>
                            </div>
                            <div class="vote-counts">
                                <span>ุงุณุชููุงู: <span id="continue-count">0</span></span>
                                <span>ุฅููุงุก: <span id="end-count">0</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- ุงูุชุตููุช ุงูููุงุฆู -->
                    <div id="final-vote-view" class="action-view hidden">
                        <h3>๐ ุงูุชุตููุช ุงูููุงุฆู</h3>
                        <p>ูู ุชุนุชูุฏ ุฃูู ุงูุฌุงุณูุณุ (ูุง ููููู ุงูุชุตููุช ูููุณู)</p>
                        <div id="final-vote-players" class="players-grid">
                            <!-- ุฃุฒุฑุงุฑ ุงูุชุตููุช ุงูููุงุฆู -->
                        </div>
                        <div class="votes-progress">
                            <div id="final-votes-display">
                                <!-- ุนุฑุถ ุงูุฃุตูุงุช -->
                            </div>
                        </div>
                    </div>

                    <!-- ูุฑุตุฉ ุชุฎููู ุงูุฌุงุณูุณ -->
                    <div id="spy-guess-view" class="action-view hidden">
                        <h3>๐ฏ ูุฑุตุฉ ุฃุฎูุฑุฉ ููุฌุงุณูุณ!</h3>
                        <p>ูุฏูู 30 ุซุงููุฉ ูุชุฎููู ุงูููุงู!</p>
                        <div id="locations-grid" class="locations-grid">
                            <!-- ูุงุฆูุฉ ุงูุฃูุงูู -->
                        </div>
                        <div class="guess-timer">
                            โฐ ุงูููุช ุงููุชุจูู: <span id="guess-time">00:30</span>
                        </div>
                    </div>

                    <!-- ูุชุงุฆุฌ ุงููุนุจุฉ -->
                    <div id="results-view" class="action-view hidden">
                        <h3>๐ฎ ููุงูุฉ ุงููุนุจุฉ</h3>
                        <div class="results-content">
                            <div class="result-section">
                                <h4>๐ ุงููุงุฆุฒูู</h4>
                                <p id="winners-text">...</p>
                            </div>
                            <div class="result-section">
                                <h4>๐ญ ุงูุฌุงุณูุณ ูุงู</h4>
                                <p id="spy-result">...</p>
                            </div>
                            <div class="result-section">
                                <h4>๐ ุงูููุงู ูุงู</h4>
                                <p id="location-result">...</p>
                            </div>
                            <div class="result-section">
                                <h4>๐ ุฅุญุตุงุฆูุงุช ุงููุนุจุฉ</h4>
                                <ul id="game-stats">
                                    <!-- ุงูุฅุญุตุงุฆูุงุช -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- ุงูููุชุฑ -->
        <footer class="game-footer">
            <div class="footer-info">
                <p>ููุชุฑุญ ุงููุนุจุฉ: Angle | ูุทูุฑ ุงูุจูุช: Marwan Santos</p>
                <p id="voice-status" class="voice-status">๐ ุบูุฑ ูุชุตู ุจุงูุตูุช</p>
            </div>
            <div class="spectator-info">
                <small>๐๏ธ ุงููุชูุฑุฌูู: <span id="spectator-count">0</span></small>
            </div>
            <div class="debug-info">
                <small id="debug-text" class="hidden">๐ ูุถุน ุงูุชุตุญูุญ ููุนู</small>
            </div>
        </footer>
    </div>

    <!-- ูุงูุฐุฉ ุงูุชุตุญูุญ -->
    <div id="debug-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>๐ ูุนูููุงุช ุงูุชุตุญูุญ</h3>
                <button id="close-debug-btn" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="debug-section">
                    <h4>๐ ุญุงูุฉ SDK:</h4>
                    <pre id="debug-sdk-state">ุฌุงุฑู ุงูุชุญููู...</pre>
                </div>
                <div class="debug-section">
                    <h4>๐ฅ ุงููุงุนุจูู:</h4>
                    <pre id="debug-players">ุฌุงุฑู ุงูุชุญููู...</pre>
                </div>
                <div class="debug-section">
                    <h4>โ๏ธ ุงูุฃุฎุทุงุก ุงูุฃุฎูุฑุฉ:</h4>
                    <pre id="debug-errors">ูุง ุชูุฌุฏ ุฃุฎุทุงุก</pre>
                </div>
                <div class="debug-actions">
                    <button id="refresh-state-btn" class="btn btn-secondary">๐ ุชุญุฏูุซ ุงูุญุงูุฉ</button>
                    <button id="clear-log-btn" class="btn btn-warning">๐๏ธ ูุณุญ ุงูุณุฌูุงุช</button>
                    <button id="test-sdk-btn" class="btn btn-primary">๐งช ุงุฎุชุจุงุฑ ุงุชุตุงู SDK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ูููุงุช JavaScript -->
    <script src="state.js"></script>
    <script src="sdk.js"></script>
    <script src="main.js"></script>
    
    <!-- ุชููุฆุฉ SDK ุชููุงุฆููุง ุนูุฏ ุชุญููู ุงูุตูุญุฉ -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ูุดู ููุน ุงูุฌูุงุฒ ูููุน ุงูุชุดุบูู
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isInDiscord = window.DiscordNative !== undefined;
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
        
            console.log('๐ฑ ูุนูููุงุช ุงูุฌูุงุฒ:', {
                isMobile: isMobile,
                isInDiscord: isInDiscord,
                isStandalone: isStandalone,
                userAgent: navigator.userAgent.substring(0, 100)
            });

            // ุฅุฎูุงุก ุงูุฑุณุงูุฉ ุงูุฎุงุทุฆุฉ ุนู ุงููุงุชู
            const loadingError = document.getElementById('loading-error');
            if (loadingError) {
                loadingError.innerHTML = `
                    <p>โ๏ธ ุญุฏุซ ุฎุทุฃ ูู ุงูุชุญููู. ูุฑุฌู:</p>
                    <ul>
                        <li>ุงูุชุฃูุฏ ูู ุฃูู ุฏุงุฎู ุชุทุจูู Discord</li>
                        <li>ุงูุชุฃูุฏ ูู ุชูุงุฌุฏู ูู ููุงุฉ ุตูุชูุฉ</li>
                        <li>${isMobile ? 'ุงุณุชุฎุฏุงู ุชุทุจูู Discord ูููุงุชู' : 'ุชุญุฏูุซ ุงูุตูุญุฉ (F5)'}</li>
                    </ul>
                    <button id="retry-btn" class="btn btn-primary">๐ ุฅุนุงุฏุฉ ุงููุญุงููุฉ</button>
                `;
            }

            // ุชููุฆุฉ ุงููุนุจุฉ ุจููุทู ูุฎุชูู ููู ุฌูุงุฒ
            let sdkLoaded = false;
        
            // ูุญุงููุฉ ุชุญููู SDK ูุน ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุงูุชููุงุฆูุฉ
            function initializeSDK() {
                console.log(`๐ ูุญุงููุฉ ุชููุฆุฉ SDK ุนูู ${isMobile ? 'ูุงุชู' : 'ุณุทุญ ููุชุจ'}`);
            
                // ุชุฃุฎูุฑ ููุชุฃูุฏ ูู ุชุญููู ููุชุจุฉ Discord
                setTimeout(() => {
                    if (typeof Discord === 'undefined') {
                        console.error('โ ููุชุจุฉ Discord ูู ุชูุญูููู');
                        if (isMobile) {
                            // ุนูู ุงููุงุชูุ ูุฏ ุชุญุชุงุฌ ุทุฑููุฉ ูุฎุชููุฉ
                            loadSDKWithFallback();
                        } else {
                            retrySDK();
                        }
                        return;
                    }
                
                    if (window.spyfallGame) {
                        window.spyfallGame.initialize().then(function(success) {
                            if (success) {
                                console.log('โ SDK ูููุฃ ุจูุฌุงุญ');
                                sdkLoaded = true;
                                document.getElementById('loading-screen').classList.add('hidden');
                                document.getElementById('main-screen').classList.remove('hidden');
                            
                                // ุฅุฎูุงุก ุดุงุดุฉ ุงูุงุชุตุงู ุฅุฐุง ูุงูุช ูุชุตูุงู
                                if (window.discordSDK && window.discordSDK.initialized) {
                                    document.getElementById('connection-view').classList.add('hidden');
                                    document.getElementById('round-view').classList.remove('hidden');
                                }
                            } else {
                                console.error('โ ูุดู ุชููุฆุฉ ุงููุนุจุฉ');
                                handleSDKError();
                            }
                        }).catch(function(error) {
                            console.error('โ ุฎุทุฃ ูู ุงูุชููุฆุฉ:', error);
                            handleSDKError();
                        });
                    } else {
                        console.error('โ ูุงุฆู spyfallGame ุบูุฑ ููุฌูุฏ');
                        handleSDKError();
                    }
                }, 1000);
            }

            function loadSDKWithFallback() {
                console.log('๐ ุชุญููู SDK ุจุทุฑููุฉ ุงุญุชูุงุทูุฉ ูููุงุชู');
                // ุทุฑููุฉ ุจุฏููุฉ ูููุงุชู
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/@discord/embedded-app-sdk@0.1.14'; // ุฅุตุฏุงุฑ ุซุงุจุช
                script.onload = function() {
                    console.log('โ SDK ุงุญุชูุงุทู ูุญููู');
                    initializeSDK();
                };
                script.onerror = function() {
                    console.error('โ ูุดู ุชุญููู SDK ุงูุงุญุชูุงุทู');
                    showMobileInstructions();
                };
                document.head.appendChild(script);
            }
    
            function retrySDK() {
                const maxRetries = 3;
                let currentRetry = 0;
                
                function tryAgain() {
                    if (currentRetry >= maxRetries) {
                        console.error(`โ ูุดู ุจุนุฏ ${maxRetries} ูุญุงููุงุช`);
                        if (isMobile) {
                            showMobileInstructions();
                        } else {
                            document.getElementById('loading-error').classList.remove('hidden');
                        }
                        return;
                    }
                
                    currentRetry++;
                    console.log(`๐ ุงููุญุงููุฉ ${currentRetry} ูู ${maxRetries}`);
                    
                    setTimeout(() => {
                        if (typeof Discord !== 'undefined' && window.spyfallGame) {
                            initializeSDK();
                        } else {
                            tryAgain();
                        }
                    }, 2000);
                }
            
                tryAgain();
            }

            function showMobileInstructions() {
                const instructions = `
                    <div class="mobile-instructions">
                        <h3>๐ฑ ูุชุดุบูู ุงููุนุจุฉ ุนูู ูุงุชูู:</h3>
                        <ol>
                            <li>ุงูุชุญ <strong>ุชุทุจูู Discord</strong> ุนูู ูุงุชูู</li>
                            <li>ุงูุถู ุฅูู <strong>ููุงุฉ ุตูุชูุฉ</strong></li>
                            <li>ุงููุฑ ุนูู ุฃููููุฉ <strong>"Activities"</strong> ๐ฎ ูู ุงูุฃุนูู</li>
                            <li>ุงุจุญุซ ุนู "Spyfall" ูุงุฎุชุงุฑู</li>
                            <li>ููููู ุฃูุถูุง ูุชุญ ูุฐุง ุงูุฑุงุจุท ุฏุงุฎู ุชุทุจูู Discord:<br>
                                <code>discord://activities/1428774370012041246</code>
                            </li>
                        </ol>
                        <p><em>ููุงุญุธุฉ: ูุฌุจ ุฃู ุชููู ุฏุงุฎู ุชุทุจูู Discordุ ูููุณ ูุชุตูุญ ุงููุงุชู ุงูุนุงุฏู.</em></p>
                        <button onclick="location.reload()" class="btn btn-primary">๐ ุฅุนุงุฏุฉ ุชุญููู</button>
                        <button onclick="window.open('discord://activities/1428774370012041246', '_blank')" class="btn btn-success">
                            ๐ ูุชุญ ูู Discord
                        </button>
                    </div>
                `;
                
                loadingError.innerHTML = instructions;
                loadingError.classList.remove('hidden');
            }

            function handleSDKError() {
                if (isMobile) {
                    showMobileInstructions();
                } else {
                    document.getElementById('loading-error').classList.remove('hidden');
                }
            }

        // ุจุฏุก ุงูุชููุฆุฉ
            initializeSDK();

            // ุฒุฑ ุฅุนุงุฏุฉ ุงููุญุงููุฉ
            document.addEventListener('click', function(e) {
                if (e.target.id === 'retry-btn') {
                    location.reload();
                }
            });
        });
    </script>
</body>
    </html>
